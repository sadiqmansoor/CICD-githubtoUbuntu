name: Build and Deploy .NET Core Console App to Ubuntu EC2

on:
  push:
    branches:
      - master  # Trigger on push to master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: âœ… Checkout code
      uses: actions/checkout@v3

    - name: ğŸ§° Setup .NET SDK
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'  # Match your target framework

    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore

    - name: ğŸ› ï¸ Build application (solution or project)
      run: dotnet build --configuration Release

    - name: ğŸš€ Publish application for Ubuntu
      run: dotnet publish ./src/CICD-githubtoUbuntu.csproj -c Release -r linux-x64 --self-contained -o ./publish

    - name: ğŸ“¤ Upload published app to EC2 via SCP
      run: |
        echo "Uploading to EC2..."
        scp -i ${{ secrets.EC2_SSH_KEY }} -r ./publish ubuntu@${{ secrets.EC2_HOST }}:/home/ubuntu/app

    - name: ğŸ§¨ Run app remotely via SSH
      run: |
        echo "Starting app on EC2..."
        ssh -i ${{ secrets.EC2_SSH_KEY }} ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
          cd /home/ubuntu/app
          chmod +x YourAppExecutable  # Replace with actual filename
          ./YourAppExecutable &
        EOF
